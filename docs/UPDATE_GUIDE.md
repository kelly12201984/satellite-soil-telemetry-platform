# Update & Upgrade Guide

Quick reference for deploying updates and handling database migrations.

## ‚úÖ Automatic Updates

**Good news**: The system is configured for automatic database migrations on every deployment!

### How It Works

1. **Every `fly deploy` automatically runs migrations** via `fly.toml`:
   ```toml
   [deploy]
     release_command = "alembic upgrade head"
   ```

2. **Migrations are versioned** in `api/alembic/versions/` - each change has a unique revision

3. **Zero-downtime**: Migrations run before the new code is deployed

## üöÄ Deploying Updates

### Standard Update Process

```bash
# 1. Pull latest code
git pull origin main

# 2. Test locally (optional but recommended)
alembic upgrade head  # Test migrations
uvicorn api.app.main:app --reload  # Test API

# 3. Deploy (migrations run automatically)
fly deploy

# 4. Verify
fly status
fly logs
```

### What Happens During Deploy

1. Fly.io builds new Docker image
2. **Runs `alembic upgrade head`** (applies any new migrations)
3. Deploys new container
4. Health checks pass ‚Üí traffic routes to new version

## üìä Database Migrations

### Creating New Migrations

When you change models in `api/app/models/`:

```bash
# 1. Generate migration
alembic revision --autogenerate -m "add new field to device table"

# 2. Review the generated file in api/alembic/versions/
# Edit if needed (add data migrations, etc.)

# 3. Test locally
alembic upgrade head

# 4. Commit and deploy
git add api/alembic/versions/XXXX_add_new_field.py
git commit -m "Add migration for new field"
fly deploy  # Migration runs automatically!
```

### Testing Migrations Safely

**Option 1: Local Docker Database**
```bash
docker compose up -d db
alembic upgrade head  # Test against local DB
```

**Option 2: Neon Branch (Recommended for Production)**
1. Create a branch in Neon console from production DB
2. Set `DATABASE_URL` to branch connection string
3. Run `alembic upgrade head`
4. Test your changes
5. If all good, deploy to production

### Rolling Back Migrations

If something goes wrong:

```bash
# Rollback one migration
alembic downgrade -1

# Or rollback to specific revision
alembic downgrade <revision_id>
```

**Note**: Neon also supports time-travel, so you can restore to a previous state if needed.

## üîç Checking Migration Status

```bash
# See current migration version
alembic current

# See migration history
alembic history

# See what migrations are pending
alembic heads
```

## ‚ö†Ô∏è Important Notes

1. **Always test migrations locally first** - especially for schema changes
2. **Review autogenerated migrations** - Alembic is smart but not perfect
3. **Data migrations** - If you need to transform existing data, add it to the migration file
4. **Backup before major changes** - Use Neon branches for safety

## üêõ Troubleshooting

### Migration Fails During Deploy

1. Check logs: `fly logs`
2. If migration failed, the deploy is aborted (old version stays running)
3. Fix the migration locally
4. Test: `alembic upgrade head`
5. Redeploy: `fly deploy`

### Database Connection Issues

- Verify `DATABASE_URL` secret in Fly.io: `fly secrets list`
- Check Neon console for connection status
- Ensure SSL is enabled: connection string should include `?sslmode=require`

### Migration Already Applied

If you see "Target database is already up to date":
- This is normal if migration was already applied
- Check: `alembic current` to see current version

## üìù Example: Adding a New Field

```python
# 1. Update model in api/app/models/device.py
class Device(Base):
    # ... existing fields ...
    new_field = Column(String, nullable=True)  # Add this

# 2. Generate migration
alembic revision --autogenerate -m "add new_field to device"

# 3. Review api/alembic/versions/XXXX_add_new_field.py
# Should see: op.add_column('device', sa.Column('new_field', ...))

# 4. Test locally
alembic upgrade head

# 5. Deploy (migration runs automatically)
fly deploy
```

## üéØ Quick Commands Reference

```bash
# Deploy updates
fly deploy

# Check deployment status
fly status

# View logs
fly logs

# Check current migration
alembic current

# Create new migration
alembic revision --autogenerate -m "description"

# Apply migrations locally
alembic upgrade head

# Rollback migration
alembic downgrade -1
```

---

**Remember**: Migrations run automatically on deploy, so you just need to:
1. Create migration files when models change
2. Test locally
3. Deploy with `fly deploy`

The system handles the rest! üöÄ

